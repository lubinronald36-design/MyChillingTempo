
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>MyChillingTime â€” Interactive Notes</title>
  <style>
    body{font-family:system-ui,Arial,sans-serif;max-width:980px;margin:28px auto;padding:0 16px;line-height:1.45}
    h1{margin:0 0 6px}
    .box{padding:14px 16px;border:1px solid #ddd;border-radius:12px;margin:12px 0}
    button{padding:10px 14px;border-radius:10px;border:1px solid #111;background:#111;color:#fff;cursor:pointer}
    button:disabled{opacity:.5;cursor:not-allowed}
    select,input{padding:10px 12px;border-radius:10px;border:1px solid #bbb;background:#fff}
    kbd{padding:2px 6px;border:1px solid #ccc;border-radius:6px;background:#f7f7f7}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .small{color:#555;font-size:14px}
    .ok{color:#0a7a2f;font-weight:600}
    .bad{color:#b00020;font-weight:600}
    .keys{display:grid;grid-template-columns:repeat(8,1fr);gap:10px;margin-top:10px}
    .key{padding:12px;border:1px solid #ddd;border-radius:12px;text-align:center;background:#fff;user-select:none}
    .key.active{outline:3px solid #111}
    .hint{margin-top:6px;font-size:13px;color:#666}
    .pill{display:inline-block;padding:4px 10px;border-radius:999px;border:1px solid #ddd;background:#fafafa;font-size:12px;color:#444}
    pre{white-space:pre-wrap;background:#0b1020;color:#d7e3ff;border-radius:12px;padding:12px;border:1px solid #1c2a52}
    @media (max-width:720px){ .keys{grid-template-columns:repeat(4,1fr)} }
  </style>
</head>

<body>
  <h1>MyChillingTime ðŸŽµ</h1>
  <div class="small">Beat + playable keys + Konpa scales + Record/Loop (DEBUG mode).</div>

  <!-- DEBUG PANEL -->
  <div class="box">
    <div class="row">
      <span class="pill" id="jsPill">JS: â€¦</span>
      <span class="pill" id="audioPill">Audio: â€¦</span>
      <span class="pill" id="mp3Pill">MP3: â€¦</span>
    </div>
    <div class="row" style="margin-top:10px;">
      <button id="testBeepBtn">Test Beep (WebAudio)</button>
      <button id="testOnlineBeatBtn">Test Beat (Online MP3)</button>
      <button id="testLocalBeatBtn">Test Beat (bott.mp3)</button>
    </div>
    <div class="small" style="margin-top:10px;">
      If <b>Test Beep</b> works but MP3 doesnâ€™t â†’ beat file issue. If nothing works â†’ browser sound blocked/muted.
    </div>
    <pre id="log">Log:\n</pre>
  </div>

  <!-- Instructions + share link -->
  <div class="box">
    <div class="small"><b>How to play:</b></div>
    <div class="small">
      1) Click <b>Start Beat</b> to unlock audio ðŸŽ§<br>
      2) Use keys: <b>1 2 3 4 Q W E R A S D F Z X C V</b><br>
      3) Tap the on-screen keys on mobile ðŸ“±
    </div>
    <p class="small" style="margin-top:10px;">
      Share this link: <span id="shareLink"></span>
    </p>
  </div>

  <!-- Controls -->
  <div class="box">
    <div class="row">
      <button id="startBtn">Start Beat</button>
      <button id="stopBtn" disabled>Stop Beat</button>
      <span id="status" class="small bad">Beat: OFF</span>
      <span id="audioStatus" class="small bad">Keys: LOCKED</span>
      <span id="loopStatus" class="pill">Loop: OFF</span>
    </div>

    <div class="row" style="margin-top:10px;">
      <label class="small"><b>Scale:</b></label>
      <select id="scaleSelect">
        <option value="konpa_minor" selected>Konpa (Minor vibe)</option>
        <option value="konpa_major">Konpa (Major vibe)</option>
        <option value="pentatonic">Pentatonic (safe)</option>
      </select>

      <label class="small"><b>Loop (sec):</b></label>
      <input id="loopLen" type="number" min="1" step="0.5" value="4" style="width:90px" />

      <button id="recBtn">Record</button>
      <button id="stopRecBtn" disabled>Stop Rec</button>
      <button id="clearLoopBtn">Clear Loop</button>
    </div>

    <div class="hint">
      Tip: Click <b>Start Beat</b> (or tap any key box) once to unlock audio. Record captures your notes and loops them.
    </div>
  </div>

  <div class="box">
    <div class="small"><b>16 Keyboard Keys:</b>
      <kbd>1</kbd> <kbd>2</kbd> <kbd>3</kbd> <kbd>4</kbd>
      <kbd>Q</kbd> <kbd>W</kbd> <kbd>E</kbd> <kbd>R</kbd>
      <kbd>A</kbd> <kbd>S</kbd> <kbd>D</kbd> <kbd>F</kbd>
      <kbd>Z</kbd> <kbd>X</kbd> <kbd>C</kbd> <kbd>V</kbd>
    </div>

    <div class="keys" id="keysGrid"></div>

    <p class="small" style="margin-top:10px;">
      Notes are generated in the browser (no key.wav needed).
    </p>
  </div>

  <!-- Beat file (must be in same folder as index.html) -->
  <audio id="beat" src="bott.mp3" preload="auto" loop></audio>

  <!-- Online test beat (known working mp3) -->
  <audio id="onlineBeat" preload="auto"></audio>

  <script>
  (function () {
    const logEl = document.getElementById("log");
    const jsPill = document.getElementById("jsPill");
    const audioPill = document.getElementById("audioPill");
    const mp3Pill = document.getElementById("mp3Pill");

    function log(msg){
      logEl.textContent += msg + "\n";
    }

    // If JS runs, we immediately show it
    jsPill.textContent = "JS: OK";
    jsPill.style.borderColor = "#0a7a2f";

    // Share link (proves script is running)
    document.getElementById("shareLink").textContent = window.location.href;

    // Elements
    const beat = document.getElementById("beat");
    const onlineBeat = document.getElementById("onlineBeat");

    const startBtn = document.getElementById("startBtn");
    const stopBtn  = document.getElementById("stopBtn");
    const statusEl = document.getElementById("status");
    const audioStatus = document.getElementById("audioStatus");
    const loopStatus = document.getElementById("loopStatus");
    const keysGrid = document.getElementById("keysGrid");

    const scaleSelect = document.getElementById("scaleSelect");
    const loopLenInput = document.getElementById("loopLen");
    const recBtn = document.getElementById("recBtn");
    const stopRecBtn = document.getElementById("stopRecBtn");
    const clearLoopBtn = document.getElementById("clearLoopBtn");

    const testBeepBtn = document.getElementById("testBeepBtn");
    const testOnlineBeatBtn = document.getElementById("testOnlineBeatBtn");
    const testLocalBeatBtn = document.getElementById("testLocalBeatBtn");

    // Volumes
    beat.volume = 0.75;
    onlineBeat.volume = 0.75;

    // UI
    function setBeatUI(isOn){
      if (isOn) {
        statusEl.textContent = "Beat: ON";
        statusEl.classList.remove("bad");
        statusEl.classList.add("ok");
        startBtn.disabled = true;
        stopBtn.disabled = false;
      } else {
        statusEl.textContent = "Beat: OFF";
        statusEl.classList.remove("ok");
        statusEl.classList.add("bad");
        startBtn.disabled = false;
        stopBtn.disabled = true;
      }
    }

    function setKeysUI(unlocked){
      if (unlocked) {
        audioStatus.textContent = "Keys: UNLOCKED";
        audioStatus.classList.remove("bad");
        audioStatus.classList.add("ok");
        audioPill.textContent = "Audio: UNLOCKED";
        audioPill.style.borderColor = "#0a7a2f";
      } else {
        audioStatus.textContent = "Keys: LOCKED";
        audioStatus.classList.remove("ok");
        audioStatus.classList.add("bad");
        audioPill.textContent = "Audio: LOCKED";
        audioPill.style.borderColor = "#ddd";
      }
    }

    function setLoopUI(on){
      loopStatus.textContent = on ? "Loop: ON" : "Loop: OFF";
      loopStatus.style.borderColor = on ? "#0a7a2f" : "#ddd";
    }

    setBeatUI(false);
    setKeysUI(false);
    setLoopUI(false);

    // Audio unlock
    const AudioCtx = window.AudioContext || window.webkitAudioContext;
    const ctx = new AudioCtx();
    let audioUnlocked = false;

    async function unlockAudio(){
      if (audioUnlocked) return true;
      try{
        if (ctx.state !== "running") await ctx.resume();
        audioUnlocked = true;
        setKeysUI(true);
        log("Audio unlocked âœ…");
        return true;
      }catch(e){
        log("unlockAudio error: " + e);
        return false;
      }
    }

    // Note engine
    const KEY_ATTACK = 0.01;
    const KEY_PEAK   = 0.22;
    const KEY_RELEASE = 0.12;

    function playNoteAt(freq, startTime, duration = KEY_RELEASE, peak = KEY_PEAK) {
      const osc = ctx.createOscillator();
      const gain = ctx.createGain();

      osc.type = "triangle";
      osc.frequency.value = freq
