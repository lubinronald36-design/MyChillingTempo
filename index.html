<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>MyChillingTime ‚Äî Interactive Notes</title>
  <style>
    body{font-family:system-ui,Arial,sans-serif;max-width:980px;margin:28px auto;padding:0 16px;line-height:1.45}
    h1{margin:0 0 6px}
    .box{padding:14px 16px;border:1px solid #ddd;border-radius:12px;margin:12px 0}
    button{padding:10px 14px;border-radius:10px;border:1px solid #111;background:#111;color:#fff;cursor:pointer}
    button:disabled{opacity:.5;cursor:not-allowed}
    kbd{padding:2px 6px;border:1px solid #ccc;border-radius:6px;background:#f7f7f7}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .small{color:#555;font-size:14px}
    .ok{color:#0a7a2f;font-weight:600}
    .bad{color:#b00020;font-weight:600}
    .keys{display:grid;grid-template-columns:repeat(8,1fr);gap:10px;margin-top:10px}
    .key{padding:12px;border:1px solid #ddd;border-radius:12px;text-align:center;background:#fff;user-select:none}
    .key:active{transform:scale(.99)}
    .key.active{outline:3px solid #111}
    pre{white-space:pre-wrap;background:#0b1020;color:#d7e3ff;border-radius:12px;padding:12px;border:1px solid #1c2a52;max-height:220px;overflow:auto}
    @media (max-width:720px){ .keys{grid-template-columns:repeat(4,1fr)} }
  </style>
</head>
<body>
  <h1>MyChillingTime üéµ</h1>
  <div class="small">Beat + playable keys (stable build).</div>

  <div class="box">
    <div class="row">
      <button id="startBtn">Start Beat</button>
      <button id="stopBtn" disabled>Stop Beat</button>
      <span id="status" class="small bad">Beat: OFF</span>
      <span id="keysStatus" class="small bad">Keys: LOCKED</span>
    </div>

    <div class="small" style="margin-top:10px;">
      Use keyboard: <b>1 2 3 4 Q W E R A S D F Z X C V</b> (or tap the boxes).
    </div>

    <pre id="log">Log:\n</pre>
  </div>

  <div class="box">
    <div class="small"><b>Keys</b></div>
    <div class="keys" id="keysGrid"></div>
  </div>

  <!-- IMPORTANT: keep bott.mp3 in the SAME folder as this index.html -->
  <audio id="beat" src="bott.mp3" preload="auto" loop></audio>

  <script>
    // ===== helpers =====
    const logEl = document.getElementById("log");
    function log(msg){ logEl.textContent += msg + "\n"; logEl.scrollTop = logEl.scrollHeight; }

    const statusEl = document.getElementById("status");
    const keysStatusEl = document.getElementById("keysStatus");
    const startBtn = document.getElementById("startBtn");
    const stopBtn  = document.getElementById("stopBtn");
    const beat = document.getElementById("beat");

    function setBeatUI(on){
      statusEl.textContent = on ? "Beat: ON" : "Beat: OFF";
      statusEl.classList.toggle("ok", on);
      statusEl.classList.toggle("bad", !on);
      startBtn.disabled = on;
      stopBtn.disabled = !on;
    }
    function setKeysUI(unlocked){
      keysStatusEl.textContent = unlocked ? "Keys: UNLOCKED" : "Keys: LOCKED";
      keysStatusEl.classList.toggle("ok", unlocked);
      keysStatusEl.classList.toggle("bad", !unlocked);
    }

    setBeatUI(false);
    setKeysUI(false);

    // ===== WebAudio (for keys) =====
    const AudioCtx = window.AudioContext || window.webkitAudioContext;
    const ctx = new AudioCtx();
    let unlocked = false;

    async function unlockAudio(){
      if (unlocked) return true;
      try{
        if (ctx.state !== "running") await ctx.resume();
        unlocked = true;
        setKeysUI(true);
        log("Audio unlocked ‚úÖ");
        return true;
      }catch(e){
        log("unlockAudio error: " + e);
        return false;
      }
    }

    function playTone(freq){
      const now = ctx.currentTime;
      const osc = ctx.createOscillator();
      const gain = ctx.createGain();
      osc.type = "triangle";
      osc.frequency.setValueAtTime(freq, now);

      gain.gain.setValueAtTime(0, now);
      gain.gain.linearRampToValueAtTime(0.22, now + 0.01);
      gain.gain.linearRampToValueAtTime(0, now + 0.14);

      osc.connect(gain).connect(ctx.destination);
      osc.start(now);
      osc.stop(now + 0.16);
    }

    // ===== Key mapping (16 keys) =====
    const KEY_ORDER = ["1","2","3","4","Q","W","E","R","A","S","D","F","Z","X","C","V"];
    // Simple ‚Äúsafe‚Äù scale starting at C4
    const SCALE = [261.63,293.66,329.63,349.23,392.00,440.00,493.88,523.25];

    function freqForIndex(i){
      const base = SCALE[i % SCALE.length];
      return (i >= SCALE.length) ? base * 2 : base;
    }

    // On-screen keys
    const keysGrid = document.getElementById("keysGrid");
    const keyEls = new Map();
    KEY_ORDER.forEach((k, i) => {
      const div = document.createElement("div");
      div.className = "key";
      div.textContent = k;
      div.addEventListener("pointerdown", async () => {
        await unlockAudio();
        playTone(freqForIndex(i));
        flash(k);
      });
      keysGrid.appendChild(div);
      keyEls.set(k, div);
    });

    function flash(k){
      const el = keyEls.get(k);
      if (!el) return;
      el.classList.add("active");
      setTimeout(() => el.classList.remove("active"), 90);
    }

    window.addEventListener("keydown", async (e) => {
      const k = (e.key || "").toUpperCase();
      const idx = KEY_ORDER.indexOf(k);
      if (idx === -1) return;
      await unlockAudio();
      playTone(freqForIndex(idx));
      flash(k);
    });

    // ===== Beat controls =====
    async function startBeat(){
      await unlockAudio(); // same click unlocks both
      try{
        beat.currentTime = 0;
        await beat.play();     // must be user-gesture (this button click)
        setBeatUI(true);
        log("Beat started ‚úÖ");
      }catch(e){
        log("Beat play blocked/error: " + e);
        log("TIP: make sure the tab isn't muted. Try Ctrl+F5 refresh then click Start Beat again.");
      }
    }

    function stopBeat(){
      beat.pause();
      setBeatUI(false);
      log("Beat stopped ‚èπÔ∏è");
    }

    startBtn.addEventListener("click", startBeat);
    stopBtn.addEventListener("click", stopBeat);

    // Quick sanity logs
    beat.addEventListener("canplaythrough", () => log("bott.mp3 loaded ‚úÖ"));
    beat.addEventListener("error", () => log("ERROR loading bott.mp3 ‚ùå (check name/path)"));
  </script>
</body>
</html>
